<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookMyTurf Owner | Dashboard</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap"
    rel="stylesheet" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* RESET & BASE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #0D0D0D;
      color: #FFFFFF;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
      user-select: none;
    }

    a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s ease;
    }

    a:hover,
    a:focus-visible {
      color: #00D4FF;
      outline: none;
      text-decoration: underline;
    }

    ::selection {
      background: rgba(0, 212, 255, 0.22);
    }

    /* VARIABLES */
    :root {
      --accent-primary: #00D4FF;
      --accent-green: #4ade80;
      --bg-secondary: #1A1A1A;
      --bg-tertiary: #262626;
      --radius-card: 16px;
      --radius-button: 12px;
      --transition-fast: all 0.2s ease-in-out;
      --text-muted: #888888;
      --shadow-default: 0 4px 20px rgba(0, 0, 0, 0.4);
      --shadow-hover: 0 8px 30px rgba(0, 212, 255, 0.08);
    }

    /* ============ PAGE LAYOUT ============ */
    .page-wrapper {
      display: flex;
      gap: 24px;
      max-width: 1300px;
      margin: 0 auto;
      align-items: flex-start;
    }

    /* ============ LEFT SIDEBAR ============ */
    .sidebar {
      width: 240px;
      flex-shrink: 0;
      background: var(--bg-secondary);
      border-radius: var(--radius-card);
      padding: 32px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 20px;
    }

    .sidebar-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 24px;
      color: var(--accent-primary);
      border: 2px solid var(--accent-primary);
    }

    .sidebar-name {
      font-weight: 700;
      font-size: 16px;
      text-align: center;
    }

    .sidebar-email {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      word-break: break-all;
      user-select: text;
    }

    .sidebar-role {
      display: inline-block;
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(0, 212, 255, 0.15);
      color: var(--accent-primary);
      border: 1px solid var(--accent-primary);
    }

    .sidebar-btn {
      width: 100%;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid #404040;
      border-radius: var(--radius-button);
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition-fast);
      text-decoration: none;
      margin-top: 8px;
    }

    .sidebar-btn:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      text-decoration: none;
    }

    .sidebar-logout {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid #333;
      width: 100%;
    }

    .sidebar-logout button {
      width: 100%;
      padding: 10px;
      background: transparent;
      border: 1px solid #ff4d4d;
      border-radius: var(--radius-button);
      color: #ff4d4d;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition-fast);
    }

    .sidebar-logout button:hover {
      background: rgba(255, 77, 77, 0.1);
    }

    /* ============ MAIN CONTENT ============ */
    .main-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* --- Top Header Bar --- */
    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-header-left h1 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 26px;
      color: #fff;
    }

    .top-header-left p {
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .top-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-add-turf {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: var(--accent-green);
      color: #000;
      font-weight: 700;
      font-size: 14px;
      border-radius: var(--radius-button);
      border: none;
      cursor: pointer;
      transition: var(--transition-fast);
      text-decoration: none;
    }

    .btn-add-turf:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      text-decoration: none;
      color: #000;
    }

    .btn-menu {
      width: 36px;
      height: 36px;
      background: var(--bg-tertiary);
      border: 1px solid #404040;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
    }

    .btn-menu:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    /* --- Summary Cards --- */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .summary-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-card);
      padding: 28px 24px;
      border: 1px solid #2a2a2a;
      text-align: center;
      transition: var(--transition-fast);
      cursor: default;
    }

    .summary-card:hover {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-hover);
    }

    .summary-card .card-value {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 42px;
      color: #fff;
      line-height: 1.1;
      margin-bottom: 6px;
    }

    .summary-card .card-label {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    /* --- Tab Navigation --- */
    .tab-nav {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 0;
    }

    .tab-btn {
      padding: 12px 20px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tab-btn:hover {
      color: #fff;
    }

    .tab-btn.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }

    /* --- Tab Content --- */
    .tab-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-card);
      padding: 24px;
      border: 1px solid #2a2a2a;
      min-height: 200px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* --- Filter Bar --- */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .filter-bar label {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
    }

    .filter-bar select {
      background: var(--bg-tertiary);
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 8px 12px;
      color: #fff;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
    }

    .filter-bar select:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    /* --- Empty State --- */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 15px;
    }

    /* --- Booking Items (reused in Recent Bookings tab) --- */
    .booking-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .booking-item {
      background: var(--bg-tertiary);
      border-radius: var(--radius-card);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      transition: var(--transition-fast);
      cursor: default;
    }

    .booking-item:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .booking-time {
      font-weight: 700;
      font-size: 15px;
      color: var(--accent-primary);
      min-width: 130px;
    }

    .booking-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .booking-player {
      font-weight: 700;
      font-size: 15px;
    }

    .booking-contact {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .booking-status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(0, 212, 255, 0.15);
      color: var(--accent-primary);
      text-transform: uppercase;
    }

    /* --- Turf Cards (My Turfs tab) --- */
    .turf-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .turf-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-card);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      transition: var(--transition-fast);
    }

    .turf-card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .turf-info h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .turf-info p {
      font-size: 13px;
      color: var(--text-muted);
    }

    .turf-status {
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .turf-status.pending {
      background: rgba(255, 193, 7, 0.15);
      color: #ffc107;
    }

    .turf-status.approved {
      background: rgba(74, 222, 128, 0.15);
      color: var(--accent-green);
    }

    .turf-status.rejected {
      background: rgba(255, 77, 77, 0.15);
      color: #ff4d4d;
    }

    /* ============ ANALYTICS ============ */
    .analytics-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .analytics-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .metric-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-card);
      padding: 20px;
      border: 1px solid #2a2a2a;
      transition: var(--transition-fast);
    }

    .metric-card:hover {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-hover);
    }

    .metric-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-bottom: 14px;
    }

    .metric-icon.revenue {
      background: rgba(74, 222, 128, 0.12);
      color: var(--accent-green);
    }

    .metric-icon.bookings {
      background: rgba(0, 212, 255, 0.12);
      color: var(--accent-primary);
    }

    .metric-icon.rating {
      background: rgba(255, 193, 7, 0.12);
      color: #ffc107;
    }

    .metric-label {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 4px;
    }

    .metric-value {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 28px;
      color: #fff;
      line-height: 1.2;
      margin-bottom: 8px;
    }

    .metric-compare {
      font-size: 12px;
      color: var(--accent-green);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .analytics-charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .chart-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-card);
      padding: 24px;
      border: 1px solid #2a2a2a;
    }

    .chart-card h3 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .chart-placeholder {
      width: 100%;
      height: 180px;
      position: relative;
    }

    .chart-placeholder svg {
      width: 100%;
      height: 100%;
    }

    .weekly-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .weekly-stat-item .ws-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 4px;
    }

    .weekly-stat-item .ws-value {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 20px;
      color: #fff;
      margin-bottom: 2px;
    }

    .weekly-stat-item .ws-compare {
      font-size: 11px;
      color: var(--text-muted);
    }

    .weekly-change {
      font-size: 13px;
      color: var(--accent-green);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    @media (max-width: 768px) {
      .analytics-metrics {
        grid-template-columns: 1fr;
      }

      .analytics-charts {
        grid-template-columns: 1fr;
      }
    }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 960px) {
      .page-wrapper {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        position: static;
        padding: 20px;
        gap: 12px;
      }

      .sidebar-logout {
        border-top: none;
        width: auto;
        margin-top: 0;
        padding-top: 0;
      }

      .summary-cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 640px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }

      .top-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .tab-nav {
        overflow-x: auto;
      }
    }
  </style>
</head>

<body>
  <div class="page-wrapper">

    <!-- ========== LEFT SIDEBAR ========== -->
    <aside class="sidebar" aria-label="Profile sidebar">
      <div class="sidebar-avatar">
        {{ request.user.username|make_list|first|upper }}{{ request.user.username|make_list|last|upper }}
      </div>
      <div class="sidebar-name">{{ request.user.username }}</div>
      <div class="sidebar-email">{{ request.user.email }}</div>
      <span class="sidebar-role">{{ request.user.get_role_display }}</span>
      <a href="#" class="sidebar-btn">
        <i class="fa-solid fa-pen-to-square"></i> Edit Profile
      </a>

      <div class="sidebar-logout">
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
          </button>
        </form>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content" role="main" aria-label="Owner Dashboard">

      <!-- Top Header -->
      <div class="top-header">
        <div class="top-header-left">
          <h1>Owner Dashboard</h1>
          <p>Manage your turfs, slots & bookings</p>
        </div>
        <div class="top-header-actions">
          <a href="{% url 'add_turf' %}" class="btn-add-turf">
            <i class="fa-solid fa-plus"></i> Add Turf
          </a>
          <button class="btn-menu" aria-label="More options">
            <i class="fa-solid fa-ellipsis-vertical"></i>
          </button>
        </div>
      </div>

      <!-- Summary Cards -->
      <section class="summary-cards" aria-label="Summary statistics">
        <article class="summary-card">
          <div class="card-value">{{ owner_turfs|length }}</div>
          <div class="card-label">Total Turfs</div>
        </article>
        <article class="summary-card">
          <div class="card-value" id="total-bookings-count">0</div>
          <div class="card-label">Total Bookings</div>
        </article>
        <article class="summary-card">
          <div class="card-value">₹0</div>
          <div class="card-label">Revenue</div>
        </article>
      </section>

      <!-- Tab Navigation -->
      <nav class="tab-nav" role="tablist" aria-label="Dashboard sections">
        <button class="tab-btn active" role="tab" aria-selected="true" data-tab="my-turfs"
          onclick="switchTab('my-turfs', this)">
          <i class="fa-solid fa-futbol"></i> My Turfs
        </button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="recent-bookings"
          onclick="switchTab('recent-bookings', this)">
          <i class="fa-solid fa-calendar-check"></i> Recent Bookings
        </button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="analytics"
          onclick="switchTab('analytics', this)">
          <i class="fa-solid fa-chart-simple"></i> Analytics
        </button>
      </nav>

      <!-- Tab Content -->
      <div class="tab-content">

        <!-- My Turfs Panel -->
        <div class="tab-panel active" id="my-turfs" role="tabpanel">
          <div class="turf-list">
            {% if owner_turfs %}
            {% for turf in owner_turfs %}
            <div class="turf-card">
              <div class="turf-info">
                <h3>{{ turf.name }}</h3>
                <p><i class="fa-solid fa-location-dot"></i> {{ turf.city }}, {{ turf.state }}</p>
              </div>
              <div style="display:flex; align-items:center; gap:12px;">
                {% if turf.status == 'approved' %}
                <a href="{% url 'slot_management' turf.id %}"
                  style="padding:6px 14px; background:var(--bg-tertiary); border:1px solid #404040; border-radius:8px; color:#fff; font-size:13px; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:6px; transition:all 0.2s ease;"
                  onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.color='var(--accent-primary)';"
                  onmouseout="this.style.borderColor='#404040'; this.style.color='#fff';">
                  <i class="fa-solid fa-calendar-days"></i> Manage Slots
                </a>
                {% endif %}
                {% if turf.status == 'rejected' %}
                <a href="{% url 'edit_turf' turf.id %}"
                  style="padding:6px 14px; background:var(--bg-tertiary); border:1px solid #404040; border-radius:8px; color:#fff; font-size:13px; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:6px; transition:all 0.2s ease;"
                  onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.color='var(--accent-primary)';"
                  onmouseout="this.style.borderColor='#404040'; this.style.color='#fff';">
                  <i class="fa-solid fa-pen-to-square"></i> Edit
                </a>
                {% endif %}
                <span class="turf-status {{ turf.status }}">{{ turf.status }}</span>
                <span style="font-size:12px; color:var(--text-muted);">{{ turf.created_at|date:'d M Y' }}</span>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="empty-state">No turfs added yet. Click <strong>"+ Add Turf"</strong> to get started.</p>
            {% endif %}
          </div>
        </div>

        <!-- Recent Bookings Panel -->
        <div class="tab-panel" id="recent-bookings" role="tabpanel">
          <div class="filter-bar">
            <label for="booking-filter">Filter by:</label>
            <select id="booking-filter" onchange="filterBookings(this.value)">
              <option value="all" selected>All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>
          <div class="booking-list" id="booking-list">
            {% for turf in owner_turfs %}
            {% for booking in turf.turf_bookings.all %}
            {% for slot in booking.slots.all %}
            <div class="booking-item" data-date="{{ slot.date|date:'Y-m-d' }}">
              <div class="booking-time">
                <div>{{ slot.date|date:'d M Y' }}</div>
                <div style="font-size:13px; font-weight:500; color:#ccc;">{{ slot.start_time|time:'h:i A' }}</div>
              </div>
              <div class="booking-details">
                <span class="booking-player">{{ turf.name }}</span>
                <span class="booking-contact"><i class="fa-solid fa-user"></i> {{ booking.player.username }}</span>
              </div>
              <div style="text-align:right;">
                <div style="font-weight:700; font-size:15px; color:var(--accent-green);">₹{{ booking.total_amount }}
                </div>
                <span class="booking-status-badge">{{ booking.status }}</span>
              </div>
            </div>
            {% endfor %}
            {% endfor %}
            {% empty %}
            <p class="empty-state" id="no-bookings-msg">No bookings found for this period.</p>
            {% endfor %}
            <p class="empty-state" id="filter-empty-msg" style="display:none;">No bookings found for this period.</p>
          </div>
        </div>

        <!-- Analytics Panel -->
        <div class="tab-panel" id="analytics" role="tabpanel">
          <div class="analytics-section">

            <!-- Metric Cards -->
            <div class="analytics-metrics">
              <div class="metric-card">
                <div class="metric-icon revenue"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                <div class="metric-label">Revenue</div>
                <div class="metric-value" id="analytics-revenue">₹0</div>
                <div class="metric-compare" id="analytics-revenue-compare"><i class="fa-solid fa-arrow-trend-up"></i> 0%
                  vs last period</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon bookings"><i class="fa-solid fa-calendar-check"></i></div>
                <div class="metric-label">Bookings</div>
                <div class="metric-value" id="analytics-bookings">0</div>
                <div class="metric-compare" id="analytics-bookings-compare"><i class="fa-solid fa-arrow-trend-up"></i>
                  0% vs last period</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon rating"><i class="fa-solid fa-star"></i></div>
                <div class="metric-label">Rating</div>
                <div class="metric-value">0.0</div>
                <div class="metric-compare"><i class="fa-solid fa-arrow-trend-up"></i> 0% vs last period</div>
              </div>
            </div>

            <!-- Chart Sections -->
            <div class="analytics-charts">

              <!-- Revenue by Day -->
              <div class="chart-card">
                <h3><i class="fa-solid fa-chart-line" style="color:var(--accent-primary); margin-right:8px;"></i>Revenue
                  by Day</h3>
                <div class="chart-placeholder" id="revenue-chart-container">
                  <svg id="revenue-chart-svg" viewBox="0 0 400 180" preserveAspectRatio="none">
                    <!-- Grid lines -->
                    <line x1="40" y1="10" x2="40" y2="150" stroke="#2a2a2a" stroke-width="1" />
                    <line x1="40" y1="150" x2="390" y2="150" stroke="#2a2a2a" stroke-width="1" />
                    <line x1="40" y1="115" x2="390" y2="115" stroke="#1a1a1a" stroke-width="0.5" stroke-dasharray="4" />
                    <line x1="40" y1="80" x2="390" y2="80" stroke="#1a1a1a" stroke-width="0.5" stroke-dasharray="4" />
                    <line x1="40" y1="45" x2="390" y2="45" stroke="#1a1a1a" stroke-width="0.5" stroke-dasharray="4" />
                    <!-- Y-axis labels -->
                    <text x="30" y="154" fill="#888" font-size="9" text-anchor="end">0</text>
                    <text x="30" y="119" fill="#888" font-size="9" text-anchor="end">1</text>
                    <text x="30" y="84" fill="#888" font-size="9" text-anchor="end">2</text>
                    <text x="30" y="49" fill="#888" font-size="9" text-anchor="end">3</text>
                    <text x="30" y="14" fill="#888" font-size="9" text-anchor="end">4</text>
                    <!-- X-axis labels -->
                    <text x="90" y="168" fill="#888" font-size="9" text-anchor="middle">Mon</text>
                    <text x="140" y="168" fill="#888" font-size="9" text-anchor="middle">Tue</text>
                    <text x="190" y="168" fill="#888" font-size="9" text-anchor="middle">Wed</text>
                    <text x="240" y="168" fill="#888" font-size="9" text-anchor="middle">Thu</text>
                    <text x="290" y="168" fill="#888" font-size="9" text-anchor="middle">Fri</text>
                    <text x="340" y="168" fill="#888" font-size="9" text-anchor="middle">Sat</text>
                    <text x="390" y="168" fill="#888" font-size="9" text-anchor="middle">Sun</text>
                    <!-- Flat line at zero -->
                    <polyline points="90,150 140,150 190,150 240,150 290,150 340,150 390,150" fill="none"
                      stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <!-- Data dots -->
                    <circle cx="90" cy="150" r="3" fill="var(--accent-primary)" />
                    <circle cx="140" cy="150" r="3" fill="var(--accent-primary)" />
                    <circle cx="190" cy="150" r="3" fill="var(--accent-primary)" />
                    <circle cx="240" cy="150" r="3" fill="var(--accent-primary)" />
                    <circle cx="290" cy="150" r="3" fill="var(--accent-primary)" />
                    <circle cx="340" cy="150" r="3" fill="var(--accent-primary)" />
                    <circle cx="390" cy="150" r="3" fill="var(--accent-primary)" />
                  </svg>
                </div>
              </div>

              <!-- Weekly Comparison -->
              <div class="chart-card">
                <h3><i class="fa-solid fa-scale-balanced"
                    style="color:var(--accent-primary); margin-right:8px;"></i>Weekly Comparison</h3>
                <div class="weekly-stats">
                  <div class="weekly-stat-item">
                    <div class="ws-label">Bookings</div>
                    <div class="ws-value" id="wk-bookings">0</div>
                    <div class="ws-compare" id="wk-bookings-vs">vs 0</div>
                  </div>
                  <div class="weekly-stat-item">
                    <div class="ws-label">Revenue</div>
                    <div class="ws-value" id="wk-revenue">₹0.0k</div>
                    <div class="ws-compare" id="wk-revenue-vs">vs ₹0.0k</div>
                  </div>
                  <div class="weekly-stat-item">
                    <div class="ws-label">Avg/Day</div>
                    <div class="ws-value" id="wk-avg">0.0</div>
                    <div class="ws-compare" id="wk-avg-vs">vs 0.0</div>
                  </div>
                </div>
                <div class="weekly-change" id="wk-change"><i class="fa-solid fa-arrow-trend-up"></i> 0% change from last
                  week</div>
              </div>

            </div>
          </div>
        </div>

      </div>

    </main>
  </div>

  <!-- Booking data for analytics (rendered by Django) -->
  <script type="application/json" id="analytics-data">
  [
    {% for turf in owner_turfs %}
      {% for booking in turf.turf_bookings.all %}
        {"id": {{ booking.id }}, "date": "{{ booking.date|date:'Y-m-d' }}", "amount": {{ booking.total_amount }}, "status": "{{ booking.status }}"}
        {% if not forloop.last or not forloop.parentloop.last %},{% endif %}
      {% endfor %}
    {% endfor %}
  ]
  </script>

  <script>
    function switchTab(tabId, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      document.getElementById(tabId).classList.add('active');
    }

    function filterBookings(period) {
      const items = document.querySelectorAll('#booking-list .booking-item');
      const emptyMsg = document.getElementById('filter-empty-msg');
      const noBookingsMsg = document.getElementById('no-bookings-msg');
      if (items.length === 0) return;  // No bookings at all, static message is shown

      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);

      // Get Monday of current week
      const dayOfWeek = now.getDay();
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() + mondayOffset);
      weekStart.setHours(0, 0, 0, 0);
      const weekStartStr = weekStart.toISOString().slice(0, 10);

      // Get Sunday of current week
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      const weekEndStr = weekEnd.toISOString().slice(0, 10);

      // Get first and last day of current month
      const monthStartStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-01';
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const monthEndStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');

      let visibleCount = 0;

      items.forEach(item => {
        const dateStr = item.getAttribute('data-date');
        let show = false;

        switch (period) {
          case 'all':
            show = true;
            break;
          case 'today':
            show = dateStr === todayStr;
            break;
          case 'week':
            show = dateStr >= weekStartStr && dateStr <= weekEndStr;
            break;
          case 'month':
            show = dateStr >= monthStartStr && dateStr <= monthEndStr;
            break;
        }

        item.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });

      if (emptyMsg) emptyMsg.style.display = visibleCount === 0 ? '' : 'none';
      if (noBookingsMsg) noBookingsMsg.style.display = 'none';
    }

    function computeAnalytics() {
      let bookings = [];
      try {
        bookings = JSON.parse(document.getElementById('analytics-data').textContent);
      } catch (e) { return; }

      // --- Helper: get Monday of a date's week ---
      function getMonday(d) {
        const dt = new Date(d + 'T00:00:00');
        const day = dt.getDay();
        const diff = day === 0 ? -6 : 1 - day;
        dt.setDate(dt.getDate() + diff);
        return dt.toISOString().slice(0, 10);
      }

      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);
      const thisMonday = getMonday(todayStr);

      // Last week Monday
      const lastMondayDate = new Date(thisMonday + 'T00:00:00');
      lastMondayDate.setDate(lastMondayDate.getDate() - 7);
      const lastMonday = lastMondayDate.toISOString().slice(0, 10);
      const lastSundayDate = new Date(lastMondayDate);
      lastSundayDate.setDate(lastMondayDate.getDate() + 6);
      const lastSunday = lastSundayDate.toISOString().slice(0, 10);

      const thisSundayDate = new Date(thisMonday + 'T00:00:00');
      thisSundayDate.setDate(thisSundayDate.getDate() + 6);
      const thisSunday = thisSundayDate.toISOString().slice(0, 10);

      // --- Totals ---
      const totalRevenue = bookings.reduce((s, b) => s + parseFloat(b.amount), 0);
      const totalBookings = bookings.length;

      document.getElementById('analytics-revenue').textContent = '₹' + totalRevenue.toLocaleString('en-IN');
      document.getElementById('analytics-bookings').textContent = totalBookings;

      // --- This month vs last month ---
      const thisMonth = todayStr.slice(0, 7);
      const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const lastMonth = lastMonthDate.getFullYear() + '-' + String(lastMonthDate.getMonth() + 1).padStart(2, '0');

      const thisMonthRev = bookings.filter(b => b.date.slice(0, 7) === thisMonth).reduce((s, b) => s + parseFloat(b.amount), 0);
      const lastMonthRev = bookings.filter(b => b.date.slice(0, 7) === lastMonth).reduce((s, b) => s + parseFloat(b.amount), 0);
      const thisMonthCount = bookings.filter(b => b.date.slice(0, 7) === thisMonth).length;
      const lastMonthCount = bookings.filter(b => b.date.slice(0, 7) === lastMonth).length;

      function pctChange(curr, prev) {
        if (prev === 0) return curr > 0 ? 100 : 0;
        return Math.round(((curr - prev) / prev) * 100);
      }

      const revPct = pctChange(thisMonthRev, lastMonthRev);
      const bkPct = pctChange(thisMonthCount, lastMonthCount);

      function trendIcon(pct) {
        return pct >= 0
          ? '<i class="fa-solid fa-arrow-trend-up"></i>'
          : '<i class="fa-solid fa-arrow-trend-down"></i>';
      }
      function trendColor(pct) { return pct >= 0 ? 'var(--accent-green)' : '#ff4d4d'; }

      const revCompEl = document.getElementById('analytics-revenue-compare');
      revCompEl.innerHTML = trendIcon(revPct) + ' ' + Math.abs(revPct) + '% vs last month';
      revCompEl.style.color = trendColor(revPct);

      const bkCompEl = document.getElementById('analytics-bookings-compare');
      bkCompEl.innerHTML = trendIcon(bkPct) + ' ' + Math.abs(bkPct) + '% vs last month';
      bkCompEl.style.color = trendColor(bkPct);

      // --- Revenue by Day chart ---
      const dayRevenue = [0, 0, 0, 0, 0, 0, 0]; // Mon-Sun
      bookings.forEach(b => {
        if (b.date >= thisMonday && b.date <= thisSunday) {
          const dt = new Date(b.date + 'T00:00:00');
          let idx = dt.getDay() - 1; // Mon=0 ... Sat=5
          if (idx < 0) idx = 6; // Sun=6
          dayRevenue[idx] += parseFloat(b.amount);
        }
      });

      const maxRev = Math.max(...dayRevenue, 1);
      const xPositions = [90, 140, 190, 240, 290, 340, 390];
      const chartTop = 10, chartBottom = 150;
      const chartRange = chartBottom - chartTop;

      // Build nice Y-axis steps
      const yStep = Math.ceil(maxRev / 4);
      const yLabels = [0, yStep, yStep * 2, yStep * 3, yStep * 4];

      let svgContent = '';
      // Grid
      svgContent += '<line x1="40" y1="10" x2="40" y2="150" stroke="#2a2a2a" stroke-width="1"/>';
      svgContent += '<line x1="40" y1="150" x2="390" y2="150" stroke="#2a2a2a" stroke-width="1"/>';
      const gridYs = [150, 115, 80, 45, 10];
      for (let i = 0; i < 5; i++) {
        if (i > 0) svgContent += '<line x1="40" y1="' + gridYs[i] + '" x2="390" y2="' + gridYs[i] + '" stroke="#1a1a1a" stroke-width="0.5" stroke-dasharray="4"/>';
        svgContent += '<text x="30" y="' + (gridYs[i] + 4) + '" fill="#888" font-size="9" text-anchor="end">' + yLabels[i] + '</text>';
      }
      // X-axis labels
      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      for (let i = 0; i < 7; i++) {
        svgContent += '<text x="' + xPositions[i] + '" y="168" fill="#888" font-size="9" text-anchor="middle">' + dayNames[i] + '</text>';
      }
      // Polyline + dots
      const yMax = yLabels[4] || 1;
      let points = '';
      for (let i = 0; i < 7; i++) {
        const y = chartBottom - (dayRevenue[i] / yMax) * chartRange;
        points += xPositions[i] + ',' + y.toFixed(1);
        if (i < 6) points += ' ';
      }
      // Gradient fill area
      svgContent += '<defs><linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent-primary)" stop-opacity="0.3"/><stop offset="100%" stop-color="var(--accent-primary)" stop-opacity="0"/></linearGradient></defs>';
      svgContent += '<polygon points="90,' + chartBottom + ' ' + points + ' 390,' + chartBottom + '" fill="url(#chartGrad)"/>';
      svgContent += '<polyline points="' + points + '" fill="none" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
      for (let i = 0; i < 7; i++) {
        const y = chartBottom - (dayRevenue[i] / yMax) * chartRange;
        svgContent += '<circle cx="' + xPositions[i] + '" cy="' + y.toFixed(1) + '" r="3" fill="var(--accent-primary)"/>';
      }

      document.getElementById('revenue-chart-svg').innerHTML = svgContent;

      // --- Weekly Comparison ---
      const thisWeekBookings = bookings.filter(b => b.date >= thisMonday && b.date <= thisSunday);
      const lastWeekBookings = bookings.filter(b => b.date >= lastMonday && b.date <= lastSunday);

      const twCount = thisWeekBookings.length;
      const lwCount = lastWeekBookings.length;
      const twRev = thisWeekBookings.reduce((s, b) => s + parseFloat(b.amount), 0);
      const lwRev = lastWeekBookings.reduce((s, b) => s + parseFloat(b.amount), 0);
      const twAvg = twCount > 0 ? (twRev / 7).toFixed(1) : '0.0';
      const lwAvg = lwCount > 0 ? (lwRev / 7).toFixed(1) : '0.0';

      function fmtK(v) { return v >= 1000 ? '₹' + (v / 1000).toFixed(1) + 'k' : '₹' + v.toLocaleString('en-IN'); }

      document.getElementById('wk-bookings').textContent = twCount;
      document.getElementById('wk-bookings-vs').textContent = 'vs ' + lwCount;
      document.getElementById('wk-revenue').textContent = fmtK(twRev);
      document.getElementById('wk-revenue-vs').textContent = 'vs ' + fmtK(lwRev);
      document.getElementById('wk-avg').textContent = twAvg;
      document.getElementById('wk-avg-vs').textContent = 'vs ' + lwAvg;

      const weekPct = pctChange(twRev, lwRev);
      const wkChangeEl = document.getElementById('wk-change');
      wkChangeEl.innerHTML = trendIcon(weekPct) + ' ' + Math.abs(weekPct) + '% change from last week';
      wkChangeEl.style.color = trendColor(weekPct);
    }

    // Initialize everything on page load
    document.addEventListener('DOMContentLoaded', function () {
      const totalItems = document.querySelectorAll('#booking-list .booking-item').length;
      const countEl = document.getElementById('total-bookings-count');
      if (countEl) countEl.textContent = totalItems;
      filterBookings('all');
      computeAnalytics();
    });
  </script>
</body>

</html>